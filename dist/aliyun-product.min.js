!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("url"),require("crypto"),require("uuid"),require("querystring")):"function"==typeof define&&define.amd?define(["url","crypto","uuid","querystring"],e):(t=t||self).AliyunOssProSdk=e(t.url,t.crypto,t.uuid,t.querystring)}(this,function(t,e,r,n){"use strict";function a(t,e,r,n,a,s,i){try{var u=t[s](i),o=u.value}catch(t){return void r(t)}u.done?e(o):Promise.resolve(o).then(n,a)}function s(t){void 0===t&&(t={});for(var e={},r=Object.keys(t),n=0;r.length>n;n++){var a=r[n];e[a.toLowerCase()]=t[a]}return e}e=e&&e.hasOwnProperty("default")?e.default:e,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var i="application/x-www-form-urlencoded",u=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)};return function(n){var s,o;function d(t,e,r){var a;return void 0===r&&(r="RELEASE"),(a=n.call(this)||this).appKey=t,a.appSecret=Buffer.from(e,"utf8"),a.stage=r,a}(s=d).prototype=Object.create((o=n).prototype),s.prototype.constructor=s,s.__proto__=o;var c=d.prototype;return c.buildStringToSign=function(t,e,r,n,a){var s="\n",u=[t,s],o=e.accept;o&&u.push(o),u.push(s);var d=e["content-md5"];d&&u.push(d),u.push(s);var c=e["content-type"]||"";c&&u.push(c),u.push(s);var p=e.date;return p&&u.push(p),u.push(s),r&&(u.push(r),u.push(s)),c.startsWith(i)?u.push(this.buildUrl(n,a)):u.push(this.buildUrl(n)),u.join("")},c.sign=function(t){return e.createHmac("sha256",this.appSecret).update(t,"utf8").digest("base64")},c.md5=function(t){return e.createHash("md5").update(t,"utf8").digest("base64")},c.getSignHeaderKeys=function(t,e){for(var r=Object.keys(t).sort(),n=[],a=0;r.length>a;a++){var s=r[a];(s.startsWith("x-ca-")||u(e,s))&&n.push(s)}return n.sort()},c.buildUrl=function(t,e){var r=Object.assign(t.query,e),n=t.pathname;if(Object.keys(r).length){for(var a=Object.keys(r).sort(),s=Array(a.length),i=0;a.length>i;i++){var u=a[i];s[i]=r[u]&&""+r[u]?u+"="+r[u]:""+u}n+="?"+s.join("&")}return n},c.buildHeaders=function(t,e){return void 0===t&&(t={}),Object.assign({"x-ca-timestamp":Date.now(),"x-ca-key":this.appKey,"x-ca-nonce":r.v4(),"x-ca-stage":this.stage,accept:"application/json"},t,e)},c.getSignedHeadersString=function(t,e){for(var r=[],n=0;t.length>n;n++){var a=t[n];r.push(a+":"+e[a])}return r.join("\n")},c.request=function(){var e,r=(e=regeneratorRuntime.mark(function e(r,n,a,s){var u,o,d,c,p,h,f,y,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.buildHeaders(a.headers,u=a.signHeaders),d=o["content-type"]||"","POST"!==r||d.startsWith(i)||(o["content-md5"]=this.md5(a.data)),c=this.getSignHeaderKeys(o,u),o["x-ca-signature-headers"]=c.join(","),p=this.getSignedHeadersString(c,o),h=t.parse(n,!0),f=this.buildStringToSign(r,o,p,h,s),o["x-ca-signature"]=this.sign(f),y=new Request(h.href,{method:r,body:a.data,headers:o}),g=new Promise(function(t,e){fetch(y).then(function(t){if(200!==t.status)throw t.status+", "+t.statusText;return t.json()}).then(function(e){return t(e)}).catch(function(t){return e(t)})}),e.next=14,g.then(function(t){return t});case 14:return e.abrupt("return",e.sent);case 16:case"end":return e.stop()}},e,this)}),function(){var t=this,r=arguments;return new Promise(function(n,s){var i=e.apply(t,r);function u(t){a(i,n,s,u,o,"next",t)}function o(t){a(i,n,s,u,o,"throw",t)}u(void 0)})});return function(t,e,n,a){return r.apply(this,arguments)}}(),d}(function(){function e(){}var r=e.prototype;return r.get=function(e,r){void 0===r&&(r={});var a=t.parse(e,!0),i=r.query||r.data;return i&&(Object.assign(a.query,i),a.path=a.pathname+"?"+n.stringify(a.query),r.data=null,r.query=null),r.headers=s(r.headers),r.signHeaders=s(r.signHeaders),this.request("GET",a,r)},r.post=function(e,r){void 0===r&&(r={});var a=t.parse(e,!0),i=r.query;i&&(Object.assign(a.query,i),a.path=a.pathname+"?"+n.stringify(a.query),r.query=null),r.headers=s(r.headers),r.signHeaders=s(r.signHeaders);var u=r.headers,o=u["content-type"]||u["Content-Type"];o||(u["content-type"]="application/json",o=u["content-type"]);var d=r.data;return o.startsWith("application/x-www-form-urlencoded")?r.data=n.stringify(r.data):o.startsWith("application/json")?r.data=JSON.stringify(r.data):Buffer.isBuffer(r.data)||"string"==typeof r.data||(r.data=JSON.stringify(r.data)),this.request("POST",a,r,d)},r.put=function(e,r){void 0===r&&(r={});var a=t.parse(e,!0),i=r.query;i&&(Object.assign(a.query,i),a.path=a.pathname+"?"+n.stringify(a.query),r.query=null),r.headers=s(r.headers),r.signHeaders=s(r.signHeaders);var u=r.headers,o=u["content-type"]||u["Content-Type"];o||(u["content-type"]="application/json",o=u["content-type"]);var d=r.data;return o.startsWith("application/x-www-form-urlencoded")?r.data=n.stringify(r.data):o.startsWith("application/json")?r.data=JSON.stringify(r.data):Buffer.isBuffer(r.data)||"string"==typeof r.data||(r.data=JSON.stringify(r.data)),this.request("PUT",a,r,d)},r.delete=function(e,r){var a=t.parse(e,!0),i=r.query||r.data;return i&&(Object.assign(a.query,i),a.path=a.pathname+"?"+n.stringify(a.query),r.data=null,r.query=null),r.headers=s(r.headers),r.signHeaders=s(r.signHeaders),this.request("DELETE",a,r)},e}())});
