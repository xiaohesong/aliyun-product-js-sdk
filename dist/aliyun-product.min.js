!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("url"),require("crypto"),require("uuid"),require("querystring")):"function"==typeof define&&define.amd?define(["url","crypto","uuid","querystring"],t):(e=e||self).AliyunOssProSdk=t(e.url,e.crypto,e.uuid,e.querystring)}(this,function(e,t,s,r){"use strict";function a(e={}){let t={},s=Object.keys(e);for(let r=0;s.length>r;r++){let a=s[r];t[a.toLowerCase()]=e[a]}return t}t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r;class n{get(t,s={}){let n=e.parse(t,!0),i=s.query||s.data;return i&&(Object.assign(n.query,i),n.path=n.pathname+"?"+r.stringify(n.query),s.data=null,s.query=null),s.headers=a(s.headers),s.signHeaders=a(s.signHeaders),this.request("GET",n,s)}post(t,s={}){let n=e.parse(t,!0),i=s.query;i&&(Object.assign(n.query,i),n.path=n.pathname+"?"+r.stringify(n.query),s.query=null),s.headers=a(s.headers),s.signHeaders=a(s.signHeaders);let u=s.headers,d=u["content-type"]||u["Content-Type"];d||(u["content-type"]="application/json",d=u["content-type"]);let p=s.data;return d.startsWith("application/x-www-form-urlencoded")?s.data=r.stringify(s.data):d.startsWith("application/json")?s.data=JSON.stringify(s.data):Buffer.isBuffer(s.data)||"string"==typeof s.data||(s.data=JSON.stringify(s.data)),this.request("POST",n,s,p)}put(t,s={}){let n=e.parse(t,!0),i=s.query;i&&(Object.assign(n.query,i),n.path=n.pathname+"?"+r.stringify(n.query),s.query=null),s.headers=a(s.headers),s.signHeaders=a(s.signHeaders);let u=s.headers,d=u["content-type"]||u["Content-Type"];d||(u["content-type"]="application/json",d=u["content-type"]);let p=s.data;return d.startsWith("application/x-www-form-urlencoded")?s.data=r.stringify(s.data):d.startsWith("application/json")?s.data=JSON.stringify(s.data):Buffer.isBuffer(s.data)||"string"==typeof s.data||(s.data=JSON.stringify(s.data)),this.request("PUT",n,s,p)}delete(t,s){let n=e.parse(t,!0),i=s.query||s.data;return i&&(Object.assign(n.query,i),n.path=n.pathname+"?"+r.stringify(n.query),s.data=null,s.query=null),s.headers=a(s.headers),s.signHeaders=a(s.signHeaders),this.request("DELETE",n,s)}}const i="application/x-www-form-urlencoded",u=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};return class extends n{constructor(e,t,s="RELEASE"){super(),this.appKey=e,this.appSecret=Buffer.from(t,"utf8"),this.stage=s}buildStringToSign(e,t,s,r,a){const n="\n";let u=[e,n],d=t.accept;d&&u.push(d),u.push(n);let p=t["content-md5"];p&&u.push(p),u.push(n);let l=t["content-type"]||"";l&&u.push(l),u.push(n);let o=t.date;return o&&u.push(o),u.push(n),s&&(u.push(s),u.push(n)),l.startsWith(i)?u.push(this.buildUrl(r,a)):u.push(this.buildUrl(r)),u.join("")}sign(e){return t.createHmac("sha256",this.appSecret).update(e,"utf8").digest("base64")}md5(e){return t.createHash("md5").update(e,"utf8").digest("base64")}getSignHeaderKeys(e,t){let s=Object.keys(e).sort(),r=[];for(let e=0;s.length>e;e++){let a=s[e];(a.startsWith("x-ca-")||u(t,a))&&r.push(a)}return r.sort()}buildUrl(e,t){let s=Object.assign(e.query,t),r=e.pathname;if(Object.keys(s).length){let e=Object.keys(s).sort(),t=Array(e.length);for(let r=0;e.length>r;r++){let a=e[r];t[r]=s[a]&&""+s[a]?`${a}=${s[a]}`:`${a}`}r+="?"+t.join("&")}return r}buildHeaders(e={},t){return Object.assign({"x-ca-timestamp":Date.now(),"x-ca-key":this.appKey,"x-ca-nonce":s.v4(),"x-ca-stage":this.stage,accept:"application/json"},e,t)}getSignedHeadersString(e,t){let s=[];for(let r=0;e.length>r;r++){let a=e[r];s.push(a+":"+t[a])}return s.join("\n")}async request(t,s,r,a){let n=r.signHeaders,u=this.buildHeaders(r.headers,n);"POST"!==t||(u["content-type"]||"").startsWith(i)||(u["content-md5"]=this.md5(r.data));let d=this.getSignHeaderKeys(u,n);u["x-ca-signature-headers"]=d.join(",");let p=this.getSignedHeadersString(d,u),l=e.parse(s,!0),o=this.buildStringToSign(t,u,p,l,a);u["x-ca-signature"]=this.sign(o);const h=new Request(l.href,{method:t,body:r.data,headers:u}),c=new Promise((e,t)=>{fetch(h).then(e=>{if(200!==e.status)throw`${e.status}, ${e.statusText}`;return e.json()}).then(t=>e(t)).catch(e=>t(e))});return await c.then(e=>e)}}});
